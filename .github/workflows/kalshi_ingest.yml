name: Kalshi ‚Üí R2 Ingest

on:
  workflow_dispatch:
  repository_dispatch:
    types: [kalshi_ingest]

jobs:
  ingest:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run ingest
        id: ingest
        env:
          R2_ENDPOINT_URL:      ${{ secrets.R2_ENDPOINT_URL }}
          R2_ACCESS_KEY_ID:     ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_NAME:       ${{ secrets.R2_BUCKET_NAME }}
          KALSHI_API_KEY:       ${{ secrets.KALSHI_API_KEY }}
          PERIOD_INTERVAL:      ${{ vars.PERIOD_INTERVAL || '1440' }}
          LOOKBACK_DAYS:        ${{ vars.LOOKBACK_DAYS || '0' }}
          LAST_N_EVENTS:        ${{ vars.LAST_N_EVENTS || '0' }}
          RUN_BUDGET_MINUTES:   "320"
        run: python kalshi_to_r2.py

      - name: Trigger next run if needed
        if: steps.ingest.outputs.needs_rerun == 'true'
        run: |
          curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.GH_PAT }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d '{"event_type":"kalshi_ingest"}'
          echo "üîÅ Next run triggered"
